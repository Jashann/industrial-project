<!DOCTYPE html>
<html>
  <head>
    <title>Road Safety Demo with Suggestions</title>
    <meta charset="UTF-8" />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Ionicons -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <style>
      /* General Page Styles */
      body {
        margin: 0;
        padding: 0;
        background: #f4f6f8;
        font-family: "Poppins", sans-serif;
      }
      /* Map container */
      #map {
        height: 100vh;
      }
      /* Search Container */
      #search-container {
        position: absolute;
        top: 20px;
        left: 60px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 280px;
      }
      #location-input {
        width: 95%;
        display: inline-block;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
        outline: none;
        transition: border-color 0.3s;
      }
      #location-input:focus {
        border-color: #aaa;
      }
      /* Modern Button Styles */
      button {
        outline: none;
        border: none;
        font-family: inherit;
      }
      button ion-icon {
        font-size: 18px;
      }
      .flex-center {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      /* Search Button */
      #search-btn {
        width: 100%;
        padding: 10px;
        background: linear-gradient(135deg, #667eea, #0280e7);
        color: #fff;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: background 0.3s, box-shadow 0.3s;
      }
      #search-btn:hover {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      /* Download Button (top right) */
      #download-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        z-index: 1100;
        font-size: 14px;
        transition: background 0.3s, box-shadow 0.3s;
      }
      #download-btn:hover {
        background: linear-gradient(135deg, #38a169, #2f855a);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      ion-icon {
        margin-right: 10px;
      }
      #suggestions {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        top: 65px;
        left: 15px;
        right: 15px;
        z-index: 1001;
        display: none;
      }
      .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .suggestion-item:last-child {
        border-bottom: none;
      }
      .suggestion-item:hover {
        background: #f1f1f1;
      }
      /* Custom Modal Styles */
      .custom-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .custom-modal-content {
        background: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-width: 90%;
      }
      .custom-modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .custom-modal-buttons button {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s, box-shadow 0.3s;
      }
      /* Specific Modal Button Colors */
      #custom-confirm-yes {
        background: linear-gradient(135deg, #28a745, #218838);
        color: #fff;
      }
      #custom-confirm-yes:hover {
        background: linear-gradient(135deg, #218838, #1e7e34);
      }
      #custom-confirm-no {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: #fff;
      }
      #custom-confirm-no:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
      }
      #action-drag {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: #fff;
      }
      #action-drag:hover {
        background: linear-gradient(135deg, #138496, #117a8b);
      }
      #action-delete {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: #fff;
      }
      #action-delete:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
      }
      #action-rename {
        background: linear-gradient(135deg, #f6ad55, #ed8936);
        color: #fff;
      }
      #action-rename:hover {
        background: linear-gradient(135deg, #ed8936, #dd6b20);
      }
      #action-cancel {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        color: #fff;
      }
      #action-cancel:hover {
        background: linear-gradient(135deg, #5a6268, #545b62);
      }
      /* Custom Rename Modal Styles */
      #custom-rename-modal input {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="search-container">
      <input type="text" id="location-input" placeholder="Enter location" />
      <div id="suggestions"></div>
      <button id="search-btn">
        <ion-icon name="search-outline"></ion-icon> Search
      </button>
    </div>
    <div id="map"></div>

    <!-- Download Map Button (top right) -->
    <button id="download-btn" class="flex-center">
      <ion-icon name="cloud-download-outline"></ion-icon> Download
    </button>

    <!-- Custom Confirm Modal (Yes/No) -->
    <div id="custom-confirm-modal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="custom-confirm-message"></p>
        <div class="custom-modal-buttons">
          <button id="custom-confirm-yes">
            <ion-icon name="checkmark-outline"></ion-icon> Yes
          </button>
          <button id="custom-confirm-no">
            <ion-icon name="close-outline"></ion-icon> No
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Choice Modal for Marker Actions (Drag/Delete/Cancel/Rename) -->
    <div id="custom-choice-modal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="custom-choice-message"></p>
        <div class="custom-modal-buttons">
          <button id="action-drag">
            <ion-icon name="brush-outline"></ion-icon> Drag Pin
          </button>
          <button id="action-delete">
            <ion-icon name="trash-outline"></ion-icon> Delete Pin
          </button>
          <button id="action-rename">
            <ion-icon name="create-outline"></ion-icon> Rename Pin
          </button>
          <button id="action-cancel">
            <ion-icon name="close-circle-outline"></ion-icon> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Rename Modal -->
    <div id="custom-rename-modal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="custom-rename-message">Enter new pin name:</p>
        <input type="text" id="custom-rename-input" value="" />
        <div class="custom-modal-buttons" style="margin-top: 15px;">
          <button id="custom-rename-save">
            <ion-icon name="checkmark-outline"></ion-icon> Save
          </button>
          <button id="custom-rename-cancel">
            <ion-icon name="close-outline"></ion-icon> Cancel
          </button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Load leaflet-image plugin -->
    <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
    <script>
      // Custom confirm function (Yes/No)
      function customConfirm(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("custom-confirm-modal");
          const messageElement = document.getElementById("custom-confirm-message");
          const yesButton = document.getElementById("custom-confirm-yes");
          const noButton = document.getElementById("custom-confirm-no");

          messageElement.textContent = message;
          modal.style.display = "flex";

          function cleanUp() {
            modal.style.display = "none";
            yesButton.removeEventListener("click", onYes);
            noButton.removeEventListener("click", onNo);
          }
          function onYes() {
            cleanUp();
            resolve(true);
          }
          function onNo() {
            cleanUp();
            resolve(false);
          }

          yesButton.addEventListener("click", onYes);
          noButton.addEventListener("click", onNo);
        });
      }

      // Custom choice function for marker actions (Drag/Delete/Cancel/Rename)
      function customChoice(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("custom-choice-modal");
          const messageElement = document.getElementById("custom-choice-message");
          const dragButton = document.getElementById("action-drag");
          const deleteButton = document.getElementById("action-delete");
          const renameButton = document.getElementById("action-rename");
          const cancelButton = document.getElementById("action-cancel");

          messageElement.textContent = message;
          modal.style.display = "flex";

          function cleanUp() {
            modal.style.display = "none";
            dragButton.removeEventListener("click", onDrag);
            deleteButton.removeEventListener("click", onDelete);
            renameButton.removeEventListener("click", onRename);
            cancelButton.removeEventListener("click", onCancel);
          }
          function onDrag() {
            cleanUp();
            resolve("drag");
          }
          function onDelete() {
            cleanUp();
            resolve("delete");
          }
          function onRename() {
            cleanUp();
            resolve("rename");
          }
          function onCancel() {
            cleanUp();
            resolve("cancel");
          }

          dragButton.addEventListener("click", onDrag);
          deleteButton.addEventListener("click", onDelete);
          renameButton.addEventListener("click", onRename);
          cancelButton.addEventListener("click", onCancel);
        });
      }

      // Custom rename function using a custom modal.
      function customRename(currentName) {
        return new Promise((resolve) => {
          const modal = document.getElementById("custom-rename-modal");
          const input = document.getElementById("custom-rename-input");
          const saveButton = document.getElementById("custom-rename-save");
          const cancelButton = document.getElementById("custom-rename-cancel");

          input.value = currentName;
          modal.style.display = "flex";

          function cleanUp() {
            modal.style.display = "none";
            saveButton.removeEventListener("click", onSave);
            cancelButton.removeEventListener("click", onCancel);
          }
          function onSave() {
            cleanUp();
            resolve(input.value);
          }
          function onCancel() {
            cleanUp();
            resolve(null);
          }
          saveButton.addEventListener("click", onSave);
          cancelButton.addEventListener("click", onCancel);
        });
      }

      // Initialize the map.
      var map = L.map("map").setView([49.8033, -97.0823], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // (Optional) Load additional GeoJSON data.
      fetch("my_plan_latlon.geojson")
        .then((response) => response.json())
        .then((data) => {
          L.geoJSON(data, {
            onEachFeature: function (feature, layer) {
              if (feature.properties && feature.properties.label) {
                layer.bindPopup(feature.properties.label);
              }
            },
          }).addTo(map);
        });

      /**
       * Creates a marker that shows its popup on hover and, on click, prompts the user for an action.
       */
      function createInteractiveMarker(lat, lon, popupContent) {
        var marker = L.marker([lat, lon], { draggable: false }).addTo(map);
        marker.bindPopup(popupContent);

        // Show popup on hover.
        marker.on("mouseover", function () {
          marker.openPopup();
        });
        marker.on("mouseout", function () {
          marker.closePopup();
        });

        // On click, prompt for marker actions.
        marker.on("click", async function (e) {
          if (marker.dragging && marker.dragging.enabled()) return;
          const action = await customChoice("What would you like to do?");
          if (action === "drag") {
            marker.dragging.enable();
            alert(
              "You can now drag the marker. Once you finish dragging, it will automatically stop."
            );
            marker.once("dragend", function (e) {
              marker.dragging.disable();
              const newLatLng = marker.getLatLng();
              marker.setPopupContent(
                "Pin dropped at: " +
                  newLatLng.lat.toFixed(5) +
                  ", " +
                  newLatLng.lng.toFixed(5)
              );
            });
          } else if (action === "delete") {
            const confirmDelete = await customConfirm(
              "Are you sure you want to delete this marker?"
            );
            if (confirmDelete) {
              map.removeLayer(marker);
            }
          } else if (action === "rename") {
            let newName = await customRename(marker.getPopup().getContent());
            if (newName) {
              marker.setPopupContent(newName);
            }
          }
        });
        return marker;
      }

      // When the user clicks on the map, offer to add a new pin.
      map.on("click", async function (e) {
        const addPin = await customConfirm("Do you want to add a new pin here?");
        if (addPin) {
          const lat = e.latlng.lat;
          const lon = e.latlng.lng;
          createInteractiveMarker(
            lat,
            lon,
            "Pin dropped at: " + lat.toFixed(5) + ", " + lon.toFixed(5)
          ).openPopup();
        }
      });

      // Function to perform a search and add markers.
      // This version assumes a construction zone after confirmation.
      async function performSearch(query) {
        try {
          const response = await fetch(
            "https://nominatim.openstreetmap.org/search?format=json&countrycodes=ca&q=" +
              encodeURIComponent(query)
          );
          const data = await response.json();
          if (data && data.length > 0) {
            const centerResult = data[0];
            const centerLat = parseFloat(centerResult.lat);
            const centerLon = parseFloat(centerResult.lon);
            
            // Ask if the user wants to designate this area as a construction zone.
            const designate = await customConfirm(
              "Do you want to designate this area as a construction zone?"
            );
            if (!designate) {
              // Even if not designated, recenter the map and show a simple popup.
              map.setView([centerLat, centerLon], 16);
              L.popup()
                .setLatLng([centerLat, centerLon])
                .setContent("Location: " + centerResult.display_name)
                .openOn(map);
              return;
            }
            
            const markers = [];
            markers.push(
              createInteractiveMarker(
                centerLat,
                centerLon,
                "Designated Construction Zone – TC-2 Roadwork"
              )
            );
    
            // Place markers for tall cones (recommended for long-term work zones).
            const coneRadius = 0.005;
            for (let i = 0; i < 4; i++) {
              const angle = (2 * Math.PI) / 4 * i;
              const newLat = centerLat + coneRadius * Math.cos(angle);
              const newLon = centerLon + coneRadius * Math.sin(angle);
              markers.push(createInteractiveMarker(newLat, newLon, "Tall Cone"));
            }
    
            // Marker for channelization barrel (TC-63) for tapering.
            const barrelLat = centerLat + coneRadius * 1.5;
            const barrelLon = centerLon;
            markers.push(
              createInteractiveMarker(
                barrelLat,
                barrelLon,
                "Channelization Barrel (TC-63)"
              )
            );
    
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.2));
            markers[0].openPopup();
          } else {
            alert("Location not found!");
          }
        } catch (err) {
          console.error(err);
          alert("Error occurred while searching for location.");
        }
      }

      // Helper: Debounce function to limit API calls.
      function debounce(func, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      }

      const locationInput = document.getElementById("location-input");
      const suggestionsDiv = document.getElementById("suggestions");

      function fetchSuggestions(query) {
        if (query.length < 3) {
          suggestionsDiv.style.display = "none";
          return;
        }
        fetch(
          "https://nominatim.openstreetmap.org/search?format=json&countrycodes=ca&q=" +
            encodeURIComponent(query)
        )
          .then((response) => response.json())
          .then((data) => {
            suggestionsDiv.innerHTML = "";
            if (data && data.length > 0) {
              suggestionsDiv.style.display = "block";
              data.forEach(function (item) {
                const suggestionItem = document.createElement("div");
                suggestionItem.className = "suggestion-item";
                suggestionItem.textContent = item.display_name;
                suggestionItem.addEventListener("click", async function () {
                  locationInput.value = "";
                  suggestionsDiv.style.display = "none";
                  const lat = parseFloat(item.lat);
                  const lon = parseFloat(item.lon);
                  
                  // Ask if the user wants to designate this area as a construction zone.
                  const designate = await customConfirm(
                    "Do you want to designate this area as a construction zone?"
                  );
                  if (!designate) {
                    map.setView([lat, lon], 16);
                    L.popup()
                      .setLatLng([lat, lon])
                      .setContent("Location: " + item.display_name)
                      .openOn(map);
                    return;
                  }
                  
                  const markers = [];
                  markers.push(
                    createInteractiveMarker(
                      lat,
                      lon,
                      "Central: " + item.display_name
                    )
                  );
                  const radius = 0.0001;
                  for (let i = 0; i < 4; i++) {
                    const angle = (2 * Math.PI) / 6 * i;
                    const newLat = lat + radius * Math.cos(angle);
                    const newLon = lon + radius * Math.sin(angle);
                    markers.push(
                      createInteractiveMarker(newLat, newLon, "Nearby Pin " + (i + 1))
                    );
                  }
                  const group = L.featureGroup(markers);
                  map.fitBounds(group.getBounds().pad(0.2));
                  markers[0].openPopup();
                });
                suggestionsDiv.appendChild(suggestionItem);
              });
            } else {
              suggestionsDiv.style.display = "none";
            }
          })
          .catch((err) => console.error(err));
      }

      locationInput.addEventListener(
        "input",
        debounce(function (e) {
          fetchSuggestions(e.target.value);
        }, 300)
      );

      document.getElementById("search-btn").addEventListener("click", function () {
        const query = locationInput.value;
        if (query) {
          performSearch(query);
          suggestionsDiv.style.display = "none";
        }
      });

      // Download map functionality.
      document.getElementById("download-btn").addEventListener("click", function () {
        leafletImage(map, function (err, canvas) {
          if (err) {
            console.error(err);
            alert("Error generating map image.");
            return;
          }
          // Convert canvas to data URL.
          var imgData = canvas.toDataURL("image/png");
          // Create a temporary link to trigger the download.
          var link = document.createElement("a");
          link.href = imgData;
          link.download = "map.png";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      });
    </script>
  </body>
</html>
